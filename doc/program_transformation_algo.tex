\documentclass{article}
\usepackage{listings}
\usepackage{placeins}
\usepackage{algorithm}
\usepackage{algpseudocode}
\title{Program Transformation}
\begin{document}
\maketitle

%\renewcommand{\thealgorithm}{}
%\algrenewcommand{\textproc}[1]{$#1$}

\begin{algorithm}
  \caption{analyse a module}
  \begin{algorithmic}[1]
    \Function {analyse}{$M$}
      \ForAll {$F \in M$}
        \State $controlStructs \gets getTopLevelControlStructs(F.BList)$ \Comment{ControlStruct is a conditional branch or loop}
        \ForAll {$S \in controlStructs$}
          \State $analyse(S)$
        \EndFor
      \EndFor
    \EndFunction
  \end{algorithmic}
\end{algorithm}

\begin{algorithm}
  \caption{analyse a control structure}
  \begin{algorithmic}[1]
    \Function {analyse}{$S$}
      \If {$isTransformable(S)$}
        \State $transform(S)$
      \Else
        \State $controlStructs \gets getTopLevelControlStructs(S.BList)$
        \ForAll {$S' \in controlStructs$}
          \State $analyse(S')$ \Comment{do recursive transformation}
        \EndFor
      \EndIf
    \EndFunction
  \end{algorithmic}
\end{algorithm}

\begin{algorithm}
  \caption{check if a control structure is transformable}
  \begin{algorithmic}[1]
    \Function {isTransformable}{$S$}
    \If {$\forall var\in def(S),\ var\notin OUT[S]$}
      \State \textbf{return true}
    \Else
      \State \textbf{return false}
    \EndIf
    \EndFunction
  \end{algorithmic}
\end{algorithm}

\begin{algorithm}
  \caption{transform a control structure}
  \begin{algorithmic}[1]
    \Function {transform}{$S$}
      \ForAll {$B \in S$}
        \ForAll {$I \in B$}
          \If {$isCritical(I)$} \Comment{check if dereference or getElementOfArray}
            \State $insert\ I\ before\ S$
          \EndIf
        \EndFor
      \EndFor
      \State $B \gets getSuccessor(S)$
      \State $insert\ unconditional\ branch\ \textbf{br\ label\ B}\ before\ S$
    \EndFunction
  \end{algorithmic}
\end{algorithm}

\begin{algorithm}
  \caption{get all of the top level control structures in the basic block list}
  \begin{algorithmic}[1]
    \Function {getTopLevelControlStructs}{$Blist$}
      \State $ret \gets empty\ ControlStruct\ list$
      \ForAll {$B \in BList$}
        \If {$B\ is\ loop\ header$}
          \State {$LS \gets loop\ structure\ of\ B$}
          \If {$LS\ has\ one\ successor$}
            \State {$add\ LS\ to\ ret$}
            \State {$skip\ blocks\ in\ LS$}
          \Else
            \State {$B' \gets postdominator\ of\ B$}
            \State {$construct\ a\ conditional\ structure\ CS\ using\ blocks\ between\ B\ and\ B'$}
            \State {$add\ CS\ to\ ret$}
            \State {$skip\ blocks\ in\ CS$}
          \EndIf
        \ElsIf {$B\ is\ conditional\ branch\ block$} \Comment{B is 'if' or 'switch' conditional block}
          \State {$B' \gets postdominator\ of\ B$}
          \State {$construct\ a\ conditional\ structure\ CS\ using\ blocks\ between\ B\ and\ B'$}
          \State {$add\ CS\ to\ ret$}
          \State {$skip\ blocks\ in\ CS$}
        \EndIf
      \EndFor
      \State {$\textbf{return}\ ret$}
    \EndFunction
  \end{algorithmic}
\end{algorithm}

\FloatBarrier
design of ControlStruct class
\begin{lstlisting}[languag=C++]
class ControlStruct {
  vector<BasicBlock *> blocks;
  BasicBlock *header;
  BasicBlock *exit;

public:
  ControlStruct(vector<BasicBlock *> basicblocks) :
    blocks(basicblocks),
    {
  }
}
\end{lstlisting}

\renewcommand{\thealgorithm}{}
\begin{algorithm}
  \caption{design of ControlStruct class}
  \begin{algorithmic}[1]
    \State \textbf{class} ControlStruct \{
    \State vector\textless BasicBlock *\textgreater\ Blocks;
    \State
    \State \textbf{public}:
    \State ControlStruct(vector() \{
    \State \}
    \State
    \State bool isTransformable();
    \State
    \State Type getType();\Comment{Condition or Loop}
    \State
    \State vector\textless ControlStruct\textgreater\ getTopLevelControlStructs();
    \State
    \State static vector\textless ControlStruct\textgreater\ getTopLevelControlStructs(Function F);
    \State \};
  \end{algorithmic}
\end{algorithm}

\begin{algorithm}
  \caption{design of Transformation class}
  \begin{algorithmic}[1]
    \State \textbf{class} Transformation \{
    \State \textbf{public}:
    \State static analyse(Module M);
    \State
    \State static analyse(ControlStruct S);
    \State
    \State static transform(ControlStruct S);
    \State \};
  \end{algorithmic}
\end{algorithm}

\begin{lstlisting}[language=C++]
for (int i=0; i<iterations;i++) {
  do something
}
\end{lstlisting}

\end{document}
