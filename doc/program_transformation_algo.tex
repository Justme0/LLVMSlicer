\documentclass{article}

\usepackage{listings}
\usepackage{xcolor}
\usepackage{placeins}
\usepackage{algorithm}
\usepackage{algpseudocode}

\lstset{
  language=C++,
  numbers=left,
  keywordstyle=\color{blue},
  commentstyle=\color{green},
  frame=single,
  breaklines=true,
  basicstyle=\small,
}

\title{Program Transformation}

\begin{document}
\maketitle

%\renewcommand{\thealgorithm}{}
%\algrenewcommand{\textproc}[1]{$#1$}

\begin{algorithm}
  \caption{analyse a module}
  \begin{algorithmic}[1]
    \Function {analyse}{$M$}
      \ForAll {$F \in M$}
        \State $controlStructs \gets getTopLevelControlStructs(F.BList)$
        \ForAll {$S \in controlStructs$}
          \State $analyse(S)$
        \EndFor
      \EndFor
    \EndFunction
  \end{algorithmic}
\end{algorithm}

\begin{algorithm}
  \caption{analyse a control structure}
  \begin{algorithmic}[1]
    \Function {analyse}{$S$}
      \If {$isTransformable(S)$}
        \State $transform(S)$
      \Else
        \State $controlStructs \gets getTopLevelControlStructs(S.BList)$
        \ForAll {$S' \in controlStructs$}
          \State $analyse(S')$ \Comment{do recursive analysis}
        \EndFor
      \EndIf
    \EndFunction
  \end{algorithmic}
\end{algorithm}

\begin{algorithm}
  \caption{check if a control structure is transformable}
  \begin{algorithmic}[1]
    \Function {isTransformable}{$S$}
    \If {$\forall var\in def(S),\ var\notin OUT[S]$}
      \State \textbf{return true}
    \Else
      \State \textbf{return false}
    \EndIf
    \EndFunction
  \end{algorithmic}
\end{algorithm}

\begin{algorithm}
  \caption{transform a control structure}
  \begin{algorithmic}[1]
    \Function {transform}{$S$}
      \State $TI \gets S.header.getTerminator$
      \ForAll {$B \in S$}
        \ForAll {$I \in B$}
          \If {$isCritical(I)$} \Comment{check if dereference or getElementOfArray}
            \State $insert\ I\ before\ TI$
          \EndIf
        \EndFor
      \EndFor
      \State $B \gets S.exit$
      \State $I \gets \textbf{br\ label\ B}$
      \State $replace\ TI\ with\ I$
    \EndFunction
  \end{algorithmic}
\end{algorithm}

\begin{algorithm}
  \caption{get a conditional structure from the conditional branch block}
  \begin{algorithmic}[1]
    \Function {getCondStruct}{$B$}
      \State {$B' \gets postdominator\ of\ B$}
      \State {$blocks \gets getBlocksBetween(B,\ B')$} \Comment{traverse CFG from B to B'}
      \State {$S \gets ControlStruct(blocks)$}
      \State {$\textbf{return}\ S$}
    \EndFunction
  \end{algorithmic}
\end{algorithm}

\begin{algorithm}
  \caption{get all of the top level control structures in the basic block list}
  \begin{algorithmic}[1]
    \Function {getTopLevelControlStructs}{$Blist$}
      \State $ret \gets empty\ ControlStruct\ list$
      \ForAll {$B \in BList$}
        \If {$B\ is\ loop\ header$}
          \State {$LS \gets getLoopStruct(B)$}
          \If {$LS\ has\ one\ successor$}
            \State {$add\ LS\ to\ ret$}
            \State {$skipBlocksIn(LS)$} \Comment{don't analyse blocks in LS}
          \Else
            \State {$CS \gets getCondStruct(B)$}
            \State {$add\ CS\ to\ ret$}
            \State {$skipBlocksIn(CS)$}
          \EndIf
        \ElsIf {$B\ is\ conditional\ branch\ block$} \Comment{B is 'if' or 'switch' conditional block}
          \State {$CS \gets getCondStruct(B)$}
          \State {$add\ CS\ to\ ret$}
          \State {$skipBlocksIn(CS)$}
        \EndIf
      \EndFor
      \State {$\textbf{return}\ ret$}
    \EndFunction
  \end{algorithmic}
\end{algorithm}

\FloatBarrier
\section*{Design of ControlStruct class}
\begin{lstlisting}
class ControlStruct {
  BasicBlock *_header;
  BasicBlock *_exit;
  vector<BasicBlock *> _blocks;

public:
  ControlStruct(BasicBlock *header,
                BasicBlock *exit,
                const vector<BasicBlock *> &blocks);

  BasicBlock *header();

  BasicBlock *exit();

  bool isTransformable() const;

  Type getType() const; // Condition or Loop

  vector<ControlStruct> getTopLevelControlStructs() const;

  static vector<ControlStruct> getTopLevelControlStructs(const Function &F);
}
\end{lstlisting}

\section*{Design of Transformation class}
\begin{lstlisting}
class Transformation {
public:
  static void analyse(Module &M);

  static void analyse(ControlStruct &S);

  static void transform(ControlStruct &S);
}
\end{lstlisting}

\end{document}
